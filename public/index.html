<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generator API Key</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- SETUP DESIGN SYSTEM MODERN DARK --- */
    :root {
      --primary-color: #6366f1; /* Indigo - sedikit lebih cerah untuk dark mode */
      --primary-hover: #4f46e5;
      --bg-color: #1a1a2e; /* Latar belakang sangat gelap */
      --card-bg: #2c2c44; /* Warna kartu gelap */
      --text-main: #e0e0e0; /* Teks terang */
      --text-muted: #a0a0a0; /* Teks abu-abu muda */
      --border-color: #4a4a6d; /* Border lebih gelap */
      --input-bg: #3c3c5a; /* Background input gelap */
      --radius: 12px;
      --shadow-color: rgba(0, 0, 0, 0.4); /* Bayangan lebih gelap */
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      /* Background gradient halus modern */
      background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,0.2) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,0.2) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,0.2) 0, transparent 50%);
      background-size: cover;
      margin: 0; padding: 20px;
      color: var(--text-main);
      display: flex; justify-content: center; align-items: center; min-height: 100vh;
    }

    /* --- KARTU UTAMA --- */
    .container {
      background-color: var(--card-bg);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: 0 15px 30px -5px var(--shadow-color), 0 8px 15px -6px var(--shadow-color);
      width: 100%;
      max-width: 450px; /* Lebar ideal untuk form */
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1); /* Border sangat tipis untuk aksen */
    }

    h1, h2 {
      margin-top: 0;
      color: var(--text-main);
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    h1 { margin-bottom: 10px; font-size: 28px; }
    h2 { margin-bottom: 8px; font-size: 20px; }

    p { color: var(--text-muted); font-size: 15px; line-height: 1.6; margin-bottom: 24px; }

    label {
      display: block;
      text-align: left;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted); /* Label agar sedikit lebih gelap dari teks utama */
      margin-bottom: 6px;
    }

    /* --- INPUT & TEXTAREA MODERN --- */
    input, textarea {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--input-bg);
      font-size: 15px;
      color: var(--text-main);
      box-sizing: border-box;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      background-color: var(--card-bg);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25); /* Glow yang lebih terang */
    }

    textarea#apikey {
      font-family: 'Courier New', Courier, monospace;
      font-weight: 600;
      color: #93c5fd; /* Warna biru muda yang kontras */
      background-color: #1f2937; /* Background gelap untuk kode */
      border: 1px dashed #6b7280;
      height: 80px;
      resize: none;
    }

    /* --- BUTTONS --- */
    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 10px;
    }

    /* Tombol Utama (Generate & Simpan) */
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 4px 10px -1px rgba(99, 102, 241, 0.3);
    }
    .btn-primary:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px -2px rgba(99, 102, 241, 0.4);
    }

    /* Tombol Sekunder (Copy) */
    .btn-secondary {
      background-color: var(--input-bg);
      color: var(--text-main);
      border: 1px solid var(--border-color);
      box-shadow: none;
    }
    .btn-secondary:hover {
      background-color: var(--card-bg);
      border-color: #5a5a7d;
    }

    /* --- FORM USER (Hidden Section) --- */
    #userForm {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid var(--border-color);
      display: none; 
      animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Generator API Key</h1>
    <p>Buat kunci akses API baru untuk aplikasi Anda.</p>

    <label for="appName">Nama Aplikasi / Project</label>
    <input type="text" id="appName" placeholder="Contoh: Aplikasi Mobile Saya">

    <div style="display: flex; gap: 10px;">
      <button class="btn-primary" onclick="buatApiKey()">Generate Key</button>
      <button class="btn-secondary" onclick="copyApiKey()">Salin Key</button>
    </div>

    <textarea id="apikey" readonly placeholder="Klik 'Generate Key' untuk mendapatkan API Key..."></textarea>

    <div id="userForm">
      <h2>Lengkapi Data Pengguna</h2>
      <p style="margin-bottom: 20px;">Data ini diperlukan untuk aktivasi API Key.</p>

      <div style="display: flex; gap: 10px;">
        <div style="width: 50%;">
          <label>Nama Depan</label>
          <input type="text" id="firstname" placeholder="John">
        </div>
        <div style="width: 50%;">
          <label>Nama Belakang</label>
          <input type="text" id="lastname" placeholder="Doe">
        </div>
      </div>

      <label>Alamat Email</label>
      <input type="email" id="email" placeholder="email@contoh.com">

      <button class="btn-primary" onclick="simpanUser()">Simpan & Aktivasi</button>
    </div>
  </div>

<script>
  // Variabel global
  let currentApiKeyId = null;

  // ======================
  // 1. Generate API KEY
  // ======================
  async function buatApiKey() {
    const name = document.getElementById('appName').value.trim();
    const btn = document.querySelector('button[onclick="buatApiKey()"]');
    
    if (!name) return alert("Harap isi nama aplikasi terlebih dahulu.");

    // Efek Loading Button
    const originalText = btn.innerText;
    btn.innerText = "Memproses...";
    btn.disabled = true;

    try {
      const res = await fetch('/api/keys', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });

      const data = await res.json();

      if (res.ok) {
        document.getElementById('apikey').value = data.key;
        currentApiKeyId = data.id; 
        
        // Tampilkan form user dengan animasi
        document.getElementById('userForm').style.display = "block";
      } else {
        alert(data.error || "Gagal membuat key");
      }
    } catch (err) {
      console.error(err);
      alert("Terjadi kesalahan koneksi.");
    } finally {
      // Kembalikan tombol
      btn.innerText = originalText;
      btn.disabled = false;
    }
  }

  // ======================
  // 2. Copy API KEY
  // ======================
  function copyApiKey() {
    const textarea = document.getElementById("apikey");
    if(!textarea.value) return alert("Belum ada API Key yang dibuat.");
    
    textarea.select();
    navigator.clipboard.writeText(textarea.value);
    
    // Feedback visual sederhana (ganti text tombol sebentar)
    const btn = document.querySelector('button[onclick="copyApiKey()"]');
    const originalText = btn.innerText;
    btn.innerText = "Berhasil Disalin!";
    setTimeout(() => btn.innerText = originalText, 1500);
  }

  // ======================
  // 3. Simpan User
  // ======================
  async function simpanUser() {
    if (!currentApiKeyId) return alert("Harap generate API Key terlebih dahulu!");

    const firstname = document.getElementById("firstname").value.trim();
    const lastname = document.getElementById("lastname").value.trim();
    const email = document.getElementById("email").value.trim();

    if (!firstname || !lastname || !email) {
      return alert("Mohon lengkapi semua data diri.");
    }

    try {
      const res = await fetch('/api/users', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          firstname, lastname, email, apiKeyId: currentApiKeyId
        })
      });

      const data = await res.json();

      if (res.ok) {
        alert("Sukses! API Key berhasil diaktifkan atas nama " + firstname + " " + lastname + ".");
        window.location.reload(); 
      } else {
        alert(data.error || "Gagal menyimpan user.");
      }
    } catch (err) {
      console.error(err);
      alert("Terjadi kesalahan koneksi.");
    }
  }
</script>

</body>
</html>