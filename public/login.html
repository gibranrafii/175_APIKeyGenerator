<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- TEMA: MODERN DARK (Slate & Cyan) --- */
    :root {
      --primary-color: #0ea5e9; /* Sky Blue / Cyan Modern */
      --primary-hover: #0284c7;
      
      /* Background Gelap */
      --bg-color: #0f172a; /* Slate 900 */
      --card-bg: #1e293b; /* Slate 800 */
      
      --text-main: #f1f5f9; /* Slate 100 */
      --text-muted: #94a3b8; /* Slate 400 */
      --border-color: #334155; /* Slate 700 */
      --input-bg: #020617; /* Slate 950 */
      
      --danger-color: #ef4444;
      --success-color: #10b981;
      --radius: 12px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      /* Background Tech */
      background-image: 
        radial-gradient(at 0% 0%, hsla(199, 89%, 48%, 0.1) 0, transparent 50%), 
        radial-gradient(at 100% 100%, hsla(168, 76%, 46%, 0.08) 0, transparent 50%);
      background-size: cover;
      margin: 0; padding: 20px;
      color: var(--text-main);
    }

    /* --- LOGIN LAYOUT --- */
    .login-container {
      display: flex; justify-content: center; align-items: center; min-height: 100vh;
    }
    .login-card {
      background-color: var(--card-bg);
      padding: 40px; border-radius: var(--radius);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      width: 100%; max-width: 400px; text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
    }

    /* --- DASHBOARD LAYOUT --- */
    #dashboardSection { display: none; max-width: 1200px; margin: 0 auto; }

    /* Header Atas */
    .top-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 30px;
      background: var(--card-bg); padding: 20px 30px; border-radius: var(--radius);
      border: 1px solid var(--border-color);
    }
    .top-bar h2 { margin: 0; color: var(--primary-color); font-size: 22px; }

    /* Container Tabel (Card) */
    .table-card {
      background: var(--card-bg); border-radius: var(--radius); 
      padding: 25px; margin-bottom: 30px;
      border: 1px solid var(--border-color);
    }
    .card-title {
      color: var(--text-main); font-size: 18px; font-weight: 600;
      margin-bottom: 20px; padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    /* --- FORM ELEMENTS --- */
    input {
      width: 100%; padding: 12px; margin: 10px 0 20px 0;
      background: var(--input-bg); border: 1px solid var(--border-color);
      border-radius: 8px; color: var(--text-main); font-family: inherit;
      box-sizing: border-box;
    }
    input:focus { outline: none; border-color: var(--primary-color); }

    button {
      padding: 10px 20px; background: var(--primary-color); color: white;
      border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
      transition: 0.2s;
    }
    button:hover { background: var(--primary-hover); }

    /* Tombol Khusus */
    .btn-logout { background: transparent; border: 1px solid var(--danger-color); color: var(--danger-color); }
    .btn-logout:hover { background: var(--danger-color); color: white; }
    
    .btn-hapus { 
      padding: 6px 12px; font-size: 12px; 
      background: rgba(239, 68, 68, 0.1); color: #fca5a5;
    }
    .btn-hapus:hover { background: var(--danger-color); color: white; }

    .link-text { color: var(--primary-color); cursor: pointer; font-size: 14px; text-decoration: underline; }

    /* --- TABLE STYLE DARK --- */
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    
    th {
      background-color: #0f172a; /* Header Sangat Gelap */
      color: var(--text-muted); text-transform: uppercase; font-size: 12px;
      text-align: left; padding: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    td {
      padding: 15px; border-bottom: 1px solid var(--border-color); vertical-align: middle;
      color: var(--text-main);
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background-color: rgba(255,255,255,0.02); }

    /* Badges & Code */
    .code-text {
      font-family: 'Courier New', monospace; color: #38bdf8;
      background: rgba(56, 189, 248, 0.1); padding: 4px 8px; border-radius: 4px;
    }
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
    .bg-active { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
    .bg-expired { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }

    .hidden { display: none; }
  </style>
</head>
<body>

  <div id="loginSection" class="login-container">
    <div class="login-card">
      <h2 style="margin-top:0; color: var(--primary-color);">Admin Portal</h2>
      <p style="color: var(--text-muted);">Silakan masuk untuk melanjutkan.</p>
      
      <form onsubmit="event.preventDefault(); login();">
        <input type="email" id="email" placeholder="Email Admin" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit" style="width:100%;">MASUK SYSTEM</button>
      </form>
      
      <br>
      <span class="link-text" onclick="toggleReg()">Buat Akun Admin Baru</span>
    </div>
  </div>

  <div id="registerSection" class="login-container hidden">
    <div class="login-card">
      <h2 style="margin-top:0; color: var(--primary-color);">Registrasi</h2>
      
      <form onsubmit="event.preventDefault(); register();">
        <input type="email" id="regEmail" placeholder="Email Baru" required>
        <input type="password" id="regPass" placeholder="Password Baru" required>
        <button type="submit" style="width:100%;">DAFTAR</button>
      </form>
      
      <br>
      <span class="link-text" onclick="toggleReg()">Kembali ke Login</span>
    </div>
  </div>

  <div id="dashboardSection">
    
    <div class="top-bar">
      <div>
        <h2>Dashboard Admin</h2>
        <p style="margin:0; font-size:13px; color: var(--text-muted);">Monitoring User & API Keys</p>
      </div>
      <button onclick="logout()" class="btn-logout">KELUAR</button>
    </div>

    <div class="table-card">
      <div class="card-title">Daftar Pengguna</div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Nama Pengguna</th>
              <th>Email</th>
              <th>API Key Saat Ini</th>
              <th>Status Key</th>
              <th>Tanggal Expired</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="table-card">
      <div class="card-title">Daftar Semua API Key</div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>API Key</th>
              <th>Status</th>
              <th>Pemilik (Email)</th>
              <th>Dibuat Tanggal</th>
              <th>Expired Tanggal</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="keyTableBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // --- UTILS: Tanggal ---
    function formatDate(isoDate) {
      if(!isoDate) return "-";
      return new Date(isoDate).toLocaleDateString('id-ID', {
        day: 'numeric', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function getExpiredDate(createdAt) {
      if(!createdAt) return "-";
      const date = new Date(createdAt);
      date.setDate(date.getDate() + 30); // Tambah 30 hari
      return formatDate(date);
    }

    // --- AUTH LOGIC ---
    function toggleReg() {
      document.getElementById('loginSection').classList.toggle('hidden');
      document.getElementById('registerSection').classList.toggle('hidden');
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const res = await fetch('/auth/login', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({email, password})
        });
        const data = await res.json();
        
        if(res.ok) {
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('dashboardSection').style.display = 'block';
          loadAllData();
        } else { alert(data.error); }
      } catch(e) { alert("Koneksi Error"); }
    }

    async function register() {
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPass').value;
      try {
        const res = await fetch('/auth/register', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({email, password})
        });
        if(res.ok) { alert("Berhasil! Silakan Login."); toggleReg(); }
        else { alert("Gagal Daftar"); }
      } catch(e) { alert("Error"); }
    }

    function logout() { location.reload(); }

    // --- DATA LOADING ---
    async function loadAllData() {
      await loadUsers();
      await loadKeys();
    }

    // 1. Load Tabel Pengguna
    async function loadUsers() {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#64748b;">Loading...</td></tr>';
      
      try {
        const res = await fetch('/api/users');
        const users = await res.json();
        tbody.innerHTML = '';

        if(users.length === 0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Belum ada user.</td></tr>';

        users.forEach(u => {
          const keyData = u.ApiKey || {}; // Ambil relasi ApiKey
          const keyString = keyData.key ? `<span class="code-text">${keyData.key.substring(0, 8)}...</span>` : "-";
          
          let statusBadge = "-";
          let expiredDate = "-";

          if(keyData.key) {
            const isActive = keyData.outOfDate === false;
            statusBadge = isActive 
              ? '<span class="badge bg-active">AKTIF</span>' 
              : '<span class="badge bg-expired">EXPIRED</span>';
            expiredDate = getExpiredDate(keyData.createdAt);
          }

          const row = `
            <tr>
              <td style="font-weight:600; color:#fff;">${u.firstname} ${u.lastname}</td>
              <td style="color: var(--primary-color);">${u.email}</td>
              <td>${keyString}</td>
              <td>${statusBadge}</td>
              <td>${expiredDate}</td>
              <td><button class="btn-hapus" onclick="hapusUser(${u.id})">Hapus User</button></td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (e) { tbody.innerHTML = '<tr><td colspan="6">Error loading users</td></tr>'; }
    }

    // 2. Load Tabel Semua API Key
    async function loadKeys() {
      const tbody = document.getElementById('keyTableBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#64748b;">Loading...</td></tr>';

      try {
        const res = await fetch('/api/keys');
        const keys = await res.json();
        tbody.innerHTML = '';

        if(keys.length === 0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Belum ada key.</td></tr>';

        keys.forEach(k => {
          // Deteksi Pemilik
          let owner = '<span style="color:#64748b; font-style:italic;">Belum ada</span>';
          // Cek apakah relasinya bernama Users (hasMany) atau User (hasOne)
          if (k.Users && k.Users.length > 0) owner = k.Users[0].email;
          else if (k.User) owner = k.User.email;

          const isActive = k.outOfDate === false;
          const badge = isActive 
            ? '<span class="badge bg-active">AKTIF</span>' 
            : '<span class="badge bg-expired">EXPIRED</span>';

          const row = `
            <tr>
              <td><span class="code-text">${k.key}</span></td>
              <td>${badge}</td>
              <td>${owner}</td>
              <td>${formatDate(k.createdAt)}</td>
              <td>${getExpiredDate(k.createdAt)}</td>
              <td><button class="btn-hapus" onclick="hapusKey(${k.id})">Hapus</button></td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (e) { tbody.innerHTML = '<tr><td colspan="6">Error loading keys</td></tr>'; }
    }

    async function hapusKey(id) {
      if(confirm('Hapus key ini secara permanen?')) {
        await fetch(`/api/keys/${id}`, {method: 'DELETE'});
        loadAllData();
      }
    }
    
    // Fungsi hapus user (Opsional jika endpointnya ada)
    async function hapusUser(id) {
       alert("Fitur hapus user belum ada di backend, tapi tombolnya sudah siap!");
    }
  </script>

</body>
</html>